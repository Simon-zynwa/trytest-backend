# 邮件验证码登录功能配置指南

## 功能说明

已为项目添加邮件验证码登录功能，包含以下两个接口：

### 1. 发送邮箱验证码接口
- **接口路径**: `POST /user/sendEmailCode`
- **请求参数**:
```json
{
  "email": "user@example.com"
}
```
- **功能**: 向已注册的邮箱发送6位数字验证码，验证码有效期5分钟

### 2. 邮箱验证码登录接口
- **接口路径**: `POST /user/loginByEmail`
- **请求参数**:
```json
{
  "email": "user@example.com",
  "code": "123456"
}
```
- **功能**: 使用邮箱和验证码进行登录

## 邮件服务配置

在 `application.yml` 或 `application.properties` 中添加以下邮件配置：

### QQ邮箱配置示例 (application.yml)

```yaml
spring:
  mail:
    host: smtp.qq.com
    port: 587
    username: your-email@qq.com          # 你的QQ邮箱
    password: your-authorization-code     # QQ邮箱授权码（不是QQ密码！）
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
```

### 163邮箱配置示例 (application.yml)

```yaml
spring:
  mail:
    host: smtp.163.com
    port: 465
    username: your-email@163.com         # 你的163邮箱
    password: your-authorization-code    # 163邮箱授权码
    properties:
      mail:
        smtp:
          auth: true
          ssl:
            enable: true
```

### Gmail配置示例 (application.yml)

```yaml
spring:
  mail:
    host: smtp.gmail.com
    port: 587
    username: your-email@gmail.com       # 你的Gmail邮箱
    password: your-app-password          # Gmail应用专用密码
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
```

## 如何获取邮箱授权码

### QQ邮箱
1. 登录QQ邮箱网页版
2. 设置 → 账户 → POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务
3. 开启"POP3/SMTP服务"或"IMAP/SMTP服务"
4. 点击"生成授权码"
5. 按提示发送短信后，会得到一个16位授权码

### 163邮箱
1. 登录163邮箱网页版
2. 设置 → POP3/SMTP/IMAP
3. 开启"POP3/SMTP服务"或"IMAP/SMTP服务"
4. 设置授权码

### Gmail
1. 登录Google账户
2. 账户安全 → 两步验证（必须先开启）
3. 应用专用密码
4. 生成应用专用密码

## 验证码存储

验证码使用Redis存储，key格式为：`email:code:{email}`
- 有效期：5分钟
- 验证成功后会自动删除

## 响应码说明

| 响应码 | 说明 |
|-------|------|
| 1006 | 验证码已发送到您的邮箱 |
| 1007 | 验证码发送失败，请稍后重试 |
| 1008 | 验证码错误或已过期 |
| 1009 | 该邮箱未注册 |
| 1001 | 登录成功 |

## 代码结构

已创建/修改的文件：
- `common/src/main/java/org/example/common/util/VerificationCodeUtil.java` - 验证码生成工具
- `framework/src/main/java/org/example/framework/service/EmailService.java` - 邮件服务
- `system/src/main/java/org/example/pojo/dto/SendEmailCodeDTO.java` - 发送验证码DTO
- `system/src/main/java/org/example/pojo/dto/UserLoginByEmailDTO.java` - 邮箱登录DTO
- `common/src/main/java/org/example/common/model/Response.java` - 添加了新的响应码
- `system/src/main/java/org/example/mapper/UserMapper.java` - 添加了根据邮箱查询用户的方法
- `system/src/main/resources/mappers/UserMapper.xml` - 添加了SelectByEmail的SQL映射
- `system/src/main/java/org/example/service/UserService.java` - 添加了邮件相关接口方法
- `system/src/main/java/org/example/service/impl/UserServiceImpl.java` - 实现了邮件相关方法
- `admin/src/main/java/org/example/admin/controller/UserController.java` - 添加了两个新接口

## 测试步骤

1. **配置邮件服务**
   - 在`application.yml`中配置邮箱信息

2. **启动项目**
   - 确保Redis服务已启动
   - 启动Spring Boot应用

3. **测试发送验证码**
   ```bash
   curl -X POST http://localhost:8080/user/sendEmailCode \
   -H "Content-Type: application/json" \
   -d '{"email":"已注册的邮箱地址"}'
   ```

4. **检查邮箱**
   - 登录邮箱查看验证码邮件

5. **测试登录**
   ```bash
   curl -X POST http://localhost:8080/user/loginByEmail \
   -H "Content-Type: application/json" \
   -d '{"email":"已注册的邮箱地址","code":"收到的验证码"}'
   ```

## 注意事项

1. **邮箱必须已注册**：只有数据库中已存在的邮箱才能接收验证码
2. **Redis必须可用**：验证码存储在Redis中，请确保Redis服务正常运行
3. **授权码不是密码**：配置文件中的password是邮箱授权码，不是登录密码
4. **防火墙设置**：确保服务器可以访问SMTP服务器端口
5. **验证码有效期**：验证码5分钟后自动过期
6. **一次性使用**：验证码验证成功后会立即失效

## 下一步（手机号密码登录）

如需添加手机号密码登录功能，需要：
1. 创建`UserLoginByPhoneDTO`
2. 在`UserMapper`中添加`SelectByPhone`方法
3. 在`UserService`中添加`loginByPhone`方法
4. 在`UserController`中添加`/user/loginByPhone`接口
5. 手机号密码登录无需发送验证码，直接使用密码验证即可
